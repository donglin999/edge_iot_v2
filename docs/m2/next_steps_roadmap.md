# 下一步开发计划

**制定日期**: 2025-10-10
**当前阶段**: M2 - 核心问题修复完成
**下一阶段**: M3 - 功能完善和优化

---

## 📊 当前完成状态

### ✅ 已完成功能 (M2)

#### 后端核心
- ✅ 采集框架重构（协议抽象、存储抽象）
- ✅ Celery 异步任务系统
- ✅ Django Channels WebSocket 支持
- ✅ 配置管理 API（设备、测点、任务）
- ✅ Excel 导入系统（三种模式：replace/merge/append）
- ✅ 配置版本管理（快照、查看、回滚）
- ✅ 采集会话管理 API
- ✅ 实时状态推送（WebSocket Signals）

#### 前端核心
- ✅ 任务总览页面（DashboardPage - 仅概览）
- ✅ 采集控制页面（AcquisitionControlPage）
- ✅ 设备和测点列表（DeviceListPage）
- ✅ Excel 导入页面（ImportJobPage + 模式选择）
- ✅ 版本历史管理页面（VersionHistoryPage）
- ✅ WebSocket 实时更新集成
- ✅ 可复用组件（TaskControlPanel）

#### 测试
- ✅ 43/47 单元测试通过（91%）
- ✅ 协议 Mock 测试
- ✅ 存储 Mock 测试

### ⚠️ 待完善功能（用户反馈）

1. **设备详情页** - 未实现
2. **数据可视化图表** - 未实现
3. **版本配置应用** - 回滚仅创建记录，未应用到数据库
4. **批量操作** - 批量启停任务、批量导出配置

---

## 🎯 M3 阶段开发计划

### 优先级说明
- **P0 (Critical)**: 核心功能，必须实现
- **P1 (High)**: 重要功能，显著提升用户体验
- **P2 (Medium)**: 有价值的增强功能
- **P3 (Low)**: 锦上添花的功能

---

## Phase 1: 核心功能完善 (P0)

### 1.1 设备详情页 (8h)

**目标**: 提供完整的设备信息查看和管理界面

**后端任务**:
- [ ] `DeviceViewSet` 增强：添加 `points` action，返回设备所有测点
- [ ] 添加设备统计 API：测点数量、关联任务数、最近采集时间
- [ ] 设备连接测试 API（已存在，需验证）

**前端任务**:
- [ ] 创建 `frontend/src/pages/DeviceDetailPage.tsx`
- [ ] 设备基本信息展示（协议、IP、端口、状态）
- [ ] 测点列表表格（支持排序、筛选）
- [ ] 关联任务列表
- [ ] 连接测试按钮（实时测试设备连通性）
- [ ] 编辑设备信息（模态框）
- [ ] 删除设备确认（检查关联任务）

**UI 设计**:
```
+----------------------------------+
| 设备详情: modbus-192.168.1.10   |
+----------------------------------+
| 基本信息                          |
| 协议: ModbusTCP                   |
| IP: 192.168.1.10                 |
| 端口: 502                         |
| 状态: 在线 / 离线                |
| [测试连接] [编辑] [删除]          |
+----------------------------------+
| 测点列表 (25 个)                  |
| [搜索框]         [导出CSV]       |
| +----+------+-----+------+-----+ |
| | 编码 | 地址 | 描述 | 频率 |操作| |
| +----+------+-----+------+-----+ |
| | ...                         | |
+----------------------------------+
| 关联任务 (2 个)                   |
| - task-modbus-192.168.1.10      |
| - task-backup-modbus            |
+----------------------------------+
```

**API 端点**:
```
GET  /api/config/devices/{id}/                    # 设备详情
GET  /api/config/devices/{id}/points/             # 设备测点列表
GET  /api/config/devices/{id}/stats/              # 设备统计信息
POST /api/config/devices/{id}/test-connection/    # 测试连接
PUT  /api/config/devices/{id}/                    # 更新设备
DELETE /api/config/devices/{id}/                  # 删除设备
```

**路由**:
```tsx
<Route path="/devices/:id" element={<DeviceDetailPage />} />
```

**预计工作量**: 8 小时
- 后端 API: 2h
- 前端页面: 5h
- 测试: 1h

---

### 1.2 版本配置应用功能 (6h)

**目标**: 从历史版本真正恢复配置到数据库

**当前限制**:
- 版本回滚只创建新的 ConfigVersion 记录
- 不会更新数据库中的设备和测点
- 用户需要手动重新导入 Excel

**解决方案**:

**后端任务**:
- [ ] 在 `ConfigVersionViewSet` 添加 `apply` action
- [ ] 实现从版本 payload 恢复配置的逻辑：
  ```python
  @action(detail=True, methods=['post'], url_path='apply')
  def apply(self, request, pk=None):
      """从版本恢复配置到数据库"""
      version = self.get_object()
      task = version.task

      # 检查任务是否运行中
      # 从 payload 解析设备和测点配置
      # 更新数据库中的测点（task.points）
      # 创建新版本记录

      return Response({"detail": "配置已应用"})
  ```

**前端任务**:
- [ ] 在 `VersionHistoryPage` 添加"应用此版本"按钮
- [ ] 与"回滚到此版本"区分：
  - **回滚**: 仅创建新版本记录（payload 相同）
  - **应用**: 真正更新数据库配置
- [ ] 添加确认对话框，说明应用的影响

**API 端点**:
```
POST /api/config/versions/{id}/apply/   # 应用版本配置
```

**预计工作量**: 6 小时
- 后端逻辑: 3h
- 前端集成: 2h
- 测试: 1h

---

### 1.3 单元测试完善 (4h)

**目标**: 测试覆盖率从 91% 提升到 95%+

**待修复测试** (4 个失败):
```bash
FAILED backend/tests/test_acquisition_service.py::TestAcquisitionService::test_service_initialization
FAILED backend/tests/test_acquisition_service.py::TestAcquisitionService::test_group_points_by_device
FAILED backend/tests/test_protocols.py::TestMockModbusTCP::test_connection_success
FAILED backend/tests/test_protocols.py::TestMockModbusTCP::test_read_data
```

**任务**:
- [ ] 修复 `test_service_initialization`
- [ ] 修复 `test_group_points_by_device`
- [ ] 修复 ModbusTCP 连接测试
- [ ] 修复 ModbusTCP 数据读取测试
- [ ] 为新功能添加测试：
  - [ ] Excel 导入模式测试（replace/merge/append）
  - [ ] 版本管理 API 测试
  - [ ] WebSocket 消息推送测试

**预计工作量**: 4 小时

---

## Phase 2: 用户体验提升 (P1)

### 2.1 数据可视化 (12h)

**目标**: 实时数据监控和历史趋势分析

**技术选型**:
- **Chart.js** 或 **Recharts** (推荐 Recharts，React 原生)
- WebSocket 实时数据流

**前端任务**:
- [ ] 安装依赖: `npm install recharts`
- [ ] 创建通用图表组件：
  - [ ] `LineChart` - 折线图（实时数据）
  - [ ] `BarChart` - 柱状图（统计数据）
  - [ ] `GaugeChart` - 仪表盘（当前值）
- [ ] 创建 `DataVisualizationPage.tsx`
- [ ] 任务选择器（下拉框）
- [ ] 测点选择器（多选，最多 10 个）
- [ ] 时间范围选择（最近 1h/6h/24h/7d）
- [ ] WebSocket 实时数据订阅
- [ ] 历史数据 API 调用

**后端任务**:
- [ ] 添加历史数据查询 API：
  ```python
  GET /api/acquisition/sessions/{id}/data-points/
      ?start_time=2025-10-10T00:00:00
      &end_time=2025-10-10T23:59:59
      &point_codes=temp,pressure,flow
  ```
- [ ] 数据聚合（按时间分组，计算平均值/最大值/最小值）
- [ ] WebSocket 推送优化（仅推送用户订阅的测点）

**UI 设计**:
```
+------------------------------------------+
| 数据可视化                                |
+------------------------------------------+
| 任务: [task-modbus-192.168.1.10 ▼]      |
| 测点: [☑ 温度 ☑ 压力 ☐ 流量]  (最多10个) |
| 时间: [最近1小时 ▼]  [2025-10-10 00:00 - 08:00] |
+------------------------------------------+
| 实时数据 (折线图)                         |
| +--------------------------------------+ |
| |        温度 (°C)                     | |
| |  30 -                     ╱╲        | |
| |  25 -              ╱╲   ╱  ╲       | |
| |  20 -      ╱╲   ╱  ╲ ╱    ╲      | |
| |       00:00  00:30  01:00  01:30   | |
| +--------------------------------------+ |
| +--------------------------------------+ |
| |        压力 (kPa)                    | |
| |  ...                                 | |
| +--------------------------------------+ |
+------------------------------------------+
| 统计信息                                  |
| 温度: 当前 25.3°C | 最大 28.5°C | 最小 22.1°C |
| 压力: 当前 101.2kPa | 最大 105.3kPa | 最小 98.7kPa |
+------------------------------------------+
```

**预计工作量**: 12 小时
- 图表组件: 4h
- 数据可视化页面: 4h
- 后端 API: 2h
- WebSocket 优化: 2h

---

### 2.2 DashboardPage 数据可视化增强 (4h)

**目标**: 在总览页面添加图表，提升信息密度

**前端任务**:
- [ ] 添加任务状态饼图（运行中/已停止/启动中）
- [ ] 添加最近 24h 任务运行趋势（折线图）
- [ ] 添加错误率统计（柱状图）
- [ ] 优化布局（Grid 布局）

**UI 设计**:
```
+------------------------------------------+
| 任务总览                                  |
+------------------------------------------+
| +---------+  +---------+  +---------+   |
| | 总任务   |  | 运行中  |  | 今日启动 |   |
| |   50    |  |   12    |  |   25    |   |
| +---------+  +---------+  +---------+   |
+------------------------------------------+
| 任务状态分布 (饼图)  | 24h运行趋势(折线) |
| +-------------------+ +----------------+ |
| | ● 运行中 24%      | |      15        | |
| | ● 已停止 70%      | |   10 -  ╱╲     | |
| | ● 启动中 6%       | |    5 - ╱  ╲╱   | |
| +-------------------+ |       00-24h   | |
|                       +----------------+ |
+------------------------------------------+
| 任务列表 (表格)                           |
| ...                                      |
+------------------------------------------+
```

**预计工作量**: 4 小时

---

### 2.3 批量操作 (6h)

**目标**: 提升运维效率

**前端任务**:
- [ ] 在 `AcquisitionControlPage` 添加批量选择（checkbox）
- [ ] 批量启动按钮
- [ ] 批量停止按钮
- [ ] 批量导出配置（JSON/Excel）
- [ ] 操作确认对话框

**后端任务**:
- [ ] 添加批量启动 API：
  ```python
  POST /api/acquisition/sessions/batch-start/
  Body: {"task_ids": [1, 2, 3]}
  ```
- [ ] 添加批量停止 API
- [ ] 添加批量导出 API（返回 ZIP 文件）

**预计工作量**: 6 小时
- 前端批量选择: 2h
- 后端批量 API: 3h
- 测试: 1h

---

## Phase 3: 性能优化 (P2)

### 3.1 WebSocket 优化 (4h)

**当前问题**:
- 所有客户端连接到 `/ws/acquisition/global/`
- 接收所有任务的状态更新（浪费带宽）

**优化方案**:

**按任务订阅**:
```javascript
// 前端订阅特定任务
ws.send(JSON.stringify({
  type: 'subscribe',
  task_ids: [1, 2, 3]
}))
```

**后端任务**:
- [ ] 修改 `GlobalAcquisitionConsumer`：
  - [ ] 支持 `subscribe` 消息
  - [ ] 维护客户端订阅列表
  - [ ] 仅推送订阅的任务状态
- [ ] 添加心跳机制（30s ping/pong）
- [ ] 消息批量推送（合并 1s 内的多条更新）

**前端任务**:
- [ ] 修改 `useWebSocket` Hook：
  - [ ] 支持订阅管理
  - [ ] 心跳响应
- [ ] 在 `AcquisitionControlPage` 仅订阅当前显示的任务

**预计工作量**: 4 小时

---

### 3.2 前端性能优化 (4h)

**任务**:
- [ ] 列表虚拟化（使用 `react-window`）
  - 设备列表（>100 条记录时）
  - 测点列表（>500 条记录时）
- [ ] 路由懒加载（React.lazy + Suspense）
- [ ] 图表数据采样（>1000 个点时降采样）
- [ ] 缓存策略（React Query 或 SWR）

**预计工作量**: 4 小时

---

### 3.3 后端性能优化 (6h)

**任务**:
- [ ] 数据库查询优化：
  - [ ] 添加索引（device.code, point.code, session.task_id）
  - [ ] 使用 select_related 和 prefetch_related
  - [ ] 分页优化（Cursor Pagination）
- [ ] Excel 导入异步化：
  - [ ] 大文件（>1000 行）自动转为 Celery 任务
  - [ ] 进度反馈 API
- [ ] 采集任务优化：
  - [ ] 批量读取测点（Modbus 批量读）
  - [ ] 批量写入 InfluxDB（批量 Line Protocol）
- [ ] Redis 缓存：
  - [ ] 缓存设备列表（5 分钟）
  - [ ] 缓存任务配置（直到版本更新）

**预计工作量**: 6 小时

---

## Phase 4: 运维和监控 (P2)

### 4.1 系统监控页面 (8h)

**目标**: 监控系统健康状态

**功能**:
- [ ] Celery Worker 状态（活跃/空闲/离线）
- [ ] Redis 连接状态和内存使用
- [ ] 数据库连接池状态
- [ ] WebSocket 连接数统计
- [ ] 采集任务队列长度
- [ ] 错误日志聚合（最近 100 条）

**后端任务**:
- [ ] 创建 `monitoring` 应用（已有占位符）
- [ ] 健康检查 API：
  ```python
  GET /api/monitoring/health/
  Response: {
    "celery": {"status": "healthy", "workers": 2},
    "redis": {"status": "healthy", "memory_usage": "12.5MB"},
    "database": {"status": "healthy", "connections": 5},
    "websocket": {"connections": 3}
  }
  ```

**前端任务**:
- [ ] 创建 `SystemMonitoringPage.tsx`
- [ ] 服务状态卡片
- [ ] 实时指标图表
- [ ] 错误日志表格

**预计工作量**: 8 小时

---

### 4.2 告警系统 (12h)

**目标**: 自动检测异常并通知

**功能**:
- [ ] 告警规则配置：
  - 设备离线超过 5 分钟
  - 采集任务连续失败 3 次
  - 数据异常（超出阈值）
  - 系统资源告警（Redis/Celery 异常）
- [ ] 通知渠道：
  - 邮件通知
  - WebSocket 浏览器通知
  - Webhook（企业微信/钉钉）
- [ ] 告警历史和确认

**后端任务**:
- [ ] 创建告警模型（Alert, AlertRule）
- [ ] Celery 定时任务（检查规则）
- [ ] 通知服务（邮件/Webhook）
- [ ] 告警 API

**前端任务**:
- [ ] 告警规则配置页面
- [ ] 告警历史页面
- [ ] 浏览器通知集成

**预计工作量**: 12 小时

---

## Phase 5: 高级功能 (P3)

### 5.1 用户权限管理 (10h)

**目标**: 多用户协作和权限控制

**功能**:
- [ ] 用户角色：管理员、运维人员、查看者
- [ ] 权限控制：
  - 管理员：所有权限
  - 运维人员：启停任务、查看数据
  - 查看者：仅查看数据
- [ ] 操作审计日志

**后端任务**:
- [ ] 集成 Django Auth 和 Permissions
- [ ] 权限装饰器
- [ ] 审计日志模型

**前端任务**:
- [ ] 登录页面
- [ ] 用户管理页面
- [ ] 权限检查（按钮显示/隐藏）

**预计工作量**: 10 小时

---

### 5.2 数据导出和报表 (8h)

**目标**: 数据分析和汇报

**功能**:
- [ ] 数据导出（Excel/CSV）
  - 指定时间范围
  - 指定测点
  - 多种格式
- [ ] 定时报表（日报/周报/月报）
- [ ] 报表模板配置
- [ ] 邮件发送报表

**后端任务**:
- [ ] 数据导出 API
- [ ] 报表生成服务（Celery 定时任务）
- [ ] 邮件发送服务

**前端任务**:
- [ ] 数据导出页面
- [ ] 报表配置页面
- [ ] 报表历史查看

**预计工作量**: 8 小时

---

### 5.3 移动端适配 (6h)

**目标**: 响应式设计，支持平板和手机

**任务**:
- [ ] 响应式布局（Media Queries）
- [ ] 移动端导航（Drawer）
- [ ] 触摸优化
- [ ] 移动端测试

**预计工作量**: 6 小时

---

## 时间估算总结

| 阶段 | 功能模块 | 优先级 | 预计时间 |
|------|---------|--------|---------|
| **Phase 1** | 核心功能完善 | P0 | **18h** |
| - | 设备详情页 | P0 | 8h |
| - | 版本配置应用 | P0 | 6h |
| - | 单元测试完善 | P0 | 4h |
| **Phase 2** | 用户体验提升 | P1 | **22h** |
| - | 数据可视化 | P1 | 12h |
| - | Dashboard 图表增强 | P1 | 4h |
| - | 批量操作 | P1 | 6h |
| **Phase 3** | 性能优化 | P2 | **14h** |
| - | WebSocket 优化 | P2 | 4h |
| - | 前端性能优化 | P2 | 4h |
| - | 后端性能优化 | P2 | 6h |
| **Phase 4** | 运维和监控 | P2 | **20h** |
| - | 系统监控页面 | P2 | 8h |
| - | 告警系统 | P2 | 12h |
| **Phase 5** | 高级功能 | P3 | **24h** |
| - | 用户权限管理 | P3 | 10h |
| - | 数据导出和报表 | P3 | 8h |
| - | 移动端适配 | P3 | 6h |
| **总计** | | | **98h** |

---

## 推荐实施顺序

### 第一周 (40h)
1. **设备详情页** (8h) - P0
2. **版本配置应用** (6h) - P0
3. **单元测试完善** (4h) - P0
4. **数据可视化** (12h) - P1
5. **批量操作** (6h) - P1
6. **Dashboard 图表增强** (4h) - P1

**里程碑**: M3.1 - 核心功能完整，用户体验显著提升

### 第二周 (30h)
1. **WebSocket 优化** (4h) - P2
2. **前端性能优化** (4h) - P2
3. **后端性能优化** (6h) - P2
4. **系统监控页面** (8h) - P2
5. **告警系统** (8h/12h，部分完成) - P2

**里程碑**: M3.2 - 性能优化，运维能力增强

### 第三周 (28h)
1. **告警系统完成** (4h) - P2
2. **用户权限管理** (10h) - P3
3. **数据导出和报表** (8h) - P3
4. **移动端适配** (6h) - P3

**里程碑**: M3.3 - 高级功能完成，产品成熟

---

## 技术栈补充

### 新增依赖（前端）
```json
{
  "dependencies": {
    "recharts": "^2.10.3",          // 数据可视化
    "react-window": "^1.8.10",       // 列表虚拟化
    "react-query": "^3.39.3",        // 数据缓存和状态管理
    "@tanstack/react-table": "^8.11.0" // 高级表格
  }
}
```

### 新增依赖（后端）
```python
# requirements.txt
openpyxl>=3.1.0           # Excel 导出
pandas>=2.0.0             # 数据处理
celery-beat>=2.5.0        # 定时任务
django-cors-headers>=4.3.0 # CORS 支持（如需）
Pillow>=10.0.0            # 图片处理（报表）
```

---

## 风险和注意事项

### 技术风险
1. **WebSocket 性能**：大量连接时可能需要 Redis Pub/Sub 优化
2. **数据量问题**：历史数据查询需要分页和索引优化
3. **Excel 导入**：大文件（>10000 行）需要异步处理

### 架构决策
1. **数据可视化**：选择 Recharts（React 原生，更好的性能）
2. **状态管理**：暂不引入 Redux，使用 React Query 管理服务端状态
3. **测试策略**：单元测试覆盖率 >95%，关键路径集成测试

### 运维考虑
1. **数据备份**：定期备份 PostgreSQL 和 InfluxDB
2. **日志轮转**：使用 logrotate 管理日志文件
3. **监控告警**：集成 Prometheus + Grafana（可选）

---

## 下一步行动

### 立即行动（本周）
1. **测试当前功能** - 验证 M2 所有功能正常工作
2. **修复失败的单元测试** - 确保测试通过率 95%+
3. **用户反馈收集** - 根据实际使用调整优先级

### 下周开始
1. **设备详情页开发** - Phase 1.1
2. **版本配置应用** - Phase 1.2
3. **数据可视化调研** - 技术选型和 Demo

### 月度目标
1. **M3.1 里程碑完成** - 核心功能完整
2. **性能基准测试** - 压力测试和优化
3. **文档完善** - API 文档、用户手册、部署指南

---

## 总结

当前系统已完成核心功能（M2），下一步重点是：
1. **P0 优先级**：完善设备详情、版本应用、测试覆盖
2. **P1 优先级**：数据可视化、批量操作，提升用户体验
3. **P2 优先级**：性能优化、监控告警，提升系统稳定性
4. **P3 优先级**：权限管理、报表导出，增强企业级能力

**预计总工作量**: ~100 小时（约 2.5-3 周全职开发）

**建议**：先完成 Phase 1 和 Phase 2（~40h），再根据用户反馈调整后续计划。
