# M2 开发记录

## 阶段目标
完成前端核心功能、身份认证、实时通信、数据可视化，实现端到端可演示系统。

---

## 开发日志

### 2025-10-10
- ✅ **数据可视化功能完成**
  - 实现历史数据查询 API (`point_history`)
  - 创建 HistoricalTrendChart 组件（折线图、面积图）
  - 创建 RealtimeChart 组件（WebSocket 实时数据）
  - 创建 DataVisualizationPage 主页面
  - 实现数据统计（最大值、最小值、平均值）
  - 实现 CSV 导出功能
  - 解决 InfluxDB 外部认证问题（使用 Docker CLI 临时方案）
  - 创建 37 个模拟数据点用于测试
  - 编写完整的测试文档

### 2025-__-__ （待开发）
- 初始化 M2 阶段开发，创建计划文档。
- ...

---

## 按模块记录

### 前端核心页面

#### 总览仪表盘
- [ ] TODO: 设计仪表盘布局（任务状态、健康度、告警统计）
- [ ] TODO: 实现仪表盘组件
- [ ] TODO: 对接后端 API

#### 测点数据查询
- [ ] TODO: 实现时间选择器
- [ ] TODO: 实现测点筛选器
- [ ] TODO: 实现数据表格展示
- [ ] TODO: 集成曲线图组件

#### 配置管理优化
- [ ] TODO: 增加设备/测点详情页
- [ ] TODO: 实现编辑功能
- [ ] TODO: 实现批量操作

#### 导入作业优化
- [ ] TODO: 增加导入历史列表
- [ ] TODO: 实现详细日志查看
- [ ] TODO: 实现配置回滚功能

---

### 身份认证与权限

#### 后端认证
- [ ] TODO: 安装 djangorestframework-simplejwt
- [ ] TODO: 配置 JWT 认证
- [ ] TODO: 实现登录接口
- [ ] TODO: 实现 Token 刷新接口

#### 后端权限
- [ ] TODO: 定义角色模型（管理员/运维/观察者）
- [ ] TODO: 实现权限装饰器
- [ ] TODO: 给现有 API 添加权限控制

#### 前端认证
- [ ] TODO: 实现登录页面
- [ ] TODO: 实现 Token 存储逻辑
- [ ] TODO: 实现路由守卫
- [ ] TODO: 实现 Token 过期刷新

#### 前端权限
- [ ] TODO: 实现权限上下文
- [ ] TODO: 根据角色控制 UI 显示

---

### 实时通信

#### SSE 实现
- [ ] TODO: 调研 Django SSE 实现方案
- [ ] TODO: 实现 SSE 端点（任务状态推送）
- [ ] TODO: 前端实现 SSE 客户端
- [ ] TODO: 实现心跳与重连机制

#### 告警推送
- [ ] TODO: 定义告警规则
- [ ] TODO: 实现告警检测逻辑
- [ ] TODO: 实现告警事件推送
- [ ] TODO: 前端实现告警通知 UI

---

### 数据可视化

#### 后端数据接口
- [x] ✅ 实现 InfluxDB 查询接口 (2025-10-10)
  - 实现 `point_history` API 端点
  - 使用 Docker CLI 查询 InfluxDB（临时方案）
  - 支持时间范围查询（相对时间和绝对时间）
  - 支持数据点数量限制
- [ ] TODO: 实现数据聚合接口（小时级、天级聚合）
- [ ] TODO: 优化查询性能（缓存、索引优化）

#### 前端可视化
- [x] ✅ 集成图表库 (2025-10-10)
  - 使用 Recharts 替代 ECharts（更轻量，React 友好）
- [x] ✅ 实现曲线图组件 (2025-10-10)
  - HistoricalTrendChart: 历史趋势图（折线图、面积图）
  - RealtimeChart: 实时数据图（WebSocket）
  - 支持数据缩放（Brush）
  - 支持自定义时间范围
- [x] ✅ 实现数据统计 (2025-10-10)
  - 自动计算最大值、最小值、平均值
  - 显示数据点数量
- [x] ✅ 实现数据导出 (2025-10-10)
  - CSV 格式导出
  - 包含时间戳、数值、质量字段
- [ ] TODO: 实现多测点对比（多条曲线同时显示）
- [ ] TODO: 添加更多图表类型（散点图、柱状图）

---

### 错误处理与优化

- [ ] TODO: 前端统一错误处理中间件
- [ ] TODO: 实现 Loading/Skeleton 组件
- [ ] TODO: 实现请求重试机制
- [ ] TODO: 后端统一异常处理

---

### 测试与文档

- [ ] TODO: 编写前端单元测试
- [ ] TODO: 编写 E2E 测试
- [ ] TODO: 性能基准测试
- [ ] TODO: 用户体验测试
- [ ] TODO: 编写用户使用手册
- [ ] TODO: 更新 API 文档

---

## 问题记录

### 问题 #1: InfluxDB 外部认证失败
- **描述**：Python influxdb-client 库和 curl 从容器外部连接 InfluxDB 时返回 401 Unauthorized
- **影响**：无法使用 Python 客户端直接查询 InfluxDB
- **发现时间**：2025-10-10
- **解决方案**：使用 subprocess 调用 `docker exec influxdb influx query` 命令（临时方案）
  - 优点：可以正常工作，容器内部认证正常
  - 缺点：依赖 Docker CLI，不适合生产环境
- **根本原因**：未知（可能是 Docker 网络配置或 InfluxDB 认证配置问题）
- **状态**：【已临时解决，待优化】
- **后续计划**：排查 InfluxDB 外部认证配置，改用 Python 客户端

### 问题 #2: InfluxDB CSV 格式解析
- **描述**：初始实现无法正确解析 InfluxDB `--raw` 输出的 CSV 格式
- **影响**：API 返回空数据数组
- **发现时间**：2025-10-10
- **解决方案**：更新 CSV 解析逻辑
  - 识别以 `,result,table,` 开头的标题行
  - 识别以 `,,` 开头的数据行
  - 正确提取 `_time` 和 `_value` 字段索引
- **状态**：【已解决】

### 问题 #3（示例）
- **描述**：SSE 连接在生产环境频繁断开
- **影响**：实时推送不稳定
- **解决方案**：增加心跳检测，实现自动重连
- **状态**：【待解决 / 已解决】

---

## 性能优化记录

### 优化 #1（示例）
- **问题**：ECharts 渲染 10000+ 数据点卡顿
- **方案**：实现数据降采样算法
- **效果**：渲染时间从 5s 降至 0.5s

---

## 备注区

（记录特殊情况、临时决策等）

____________________________________________________________________
____________________________________________________________________
