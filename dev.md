# 工业 IoT 数据采集控制系统规划

## 阶段 0：调研与总体设计（~1 周）

- 梳理现有采集流程：阅读 `apps/utils/process_manager.py` 等核心模块，出系统组件图与数据流。
- 定义领域模型：设备、测点、采集任务、协议实例、数据点、告警等实体及关系。
- 评估部署与运维约束：目标运行环境、可用数据库/消息队列、容器化要求。
- 输出《架构蓝图 v1》：说明系统边界、服务划分、技术栈和非功能需求。

### 里程碑 M0

- 架构蓝图评审通过，关键技术栈（Django REST、Celery、前端框架、存储）确定。
- [Web SPA] ⇄ [Django API Gateway]
  │
  ┌───────────┼───────────┐
  │           │           │
  [配置管理服务] [任务编排服务] [数据服务]
  │           │           │
  SQLite   Dramatiq/redis InfluxDB

## 阶段 1：后端控制平面基线（~2–3 周）

- 初始化 Django 项目并接入 Django REST Framework、drf-spectacular（API 文档）。
- 建模与迁移：
  - 设备/测点/协议配置（含 Excel 导入映射）。
  - 采集任务、任务实例、运行日志。
- 接入 Celery（或 Dramatiq）+ Redis/RabbitMQ：
  - 定义任务编排 API：创建/启动/停止任务，查询运行状态。
  - 将现有协议采集逻辑拆分为独立 worker（封装原 `ProcessManager` 能力）。
- 封装 InfluxDB 访问层：统一查询接口、错误处理、权限控制。
- 提供 Mock/回放模式：无实际设备时可使用本地数据源。
- 建立基础监控：结构化日志、Prometheus/StatsD 指标输出。

### 里程碑 M1

- 第一版 REST API（配置、任务、状态、数据查询）可用，基础任务成功跑通并可在 Mock 环境验证。

## 阶段 2：前端与实时体验（~2 周）

- 选型并初始化前端（React + Vite + Ant Design 或 Vue + Element Plus）。
- 实现核心页面：
  - 总览仪表盘（进程状态、健康度、告警）。
  - 测点查询（InfluxDB 数据渲染、曲线展示）。
  - 配置管理（任务列表、Excel 上传、参数编辑）。
- 接入身份认证（JWT/Session）和权限模型（角色：管理员、运维、观察者）。
- 构建实时通道：WebSocket/SSE 订阅任务进度、告警推送。
- 与 REST/WS 联调，完善错误处理与重试。

### 里程碑 M2

- 前端可完整操作采集生命周期，实时界面稳定运行于测试环境。

## 阶段 3：测试、发布与运维（~1–2 周）

- 编写自动化测试：
  - 单元测试（Django、采集 worker）。
  - API 集成测试（pytest + httpx）。
  - 前端端到端测试（Playwright/Cypress，重点验证流程）。
- 打包与部署：
  - Docker 化（后端、worker、前端、InfluxDB/Kafka Mock）。
  - CI/CD 流水线（lint/test/build/publish）。
- 灰度 & 回滚策略：数据库迁移版本控制、任务数据备份。
- 文档交付：运维手册、API 文档、前端使用指南。

### 里程碑 M3

- CI 通过，Docker 镜像可部署；完成预生产演练并出具总结。

## 后续演进建议

- 引入统一审计日志、操作留痕。
- 结合告警策略接入消息推送（飞书/企业微信）。
- 探索设备自发现、配置版本化、模板化导入。
