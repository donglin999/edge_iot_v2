# 设备详情页测试指南

**实施日期**: 2025-10-10
**功能**: 设备详情页完整实现
**预计测试时间**: 15 分钟

---

## ✅ 已实现功能

### 后端 API (3 个新端点)
1. **GET `/api/config/devices/{id}/points/`** - 获取设备的所有测点
2. **GET `/api/config/devices/{id}/stats/`** - 获取设备统计信息
3. **POST `/api/config/devices/{id}/test-connection/`** - 测试设备连接

### 前端页面
1. **DeviceDetailPage** (`/devices/:id`) - 设备详情页
2. **DeviceListPage** 增强 - 添加"查看详情"按钮

---

## 📋 测试步骤

### 前置条件
1. ✅ 后端服务运行中: http://localhost:8000
2. ✅ 前端服务运行中: http://localhost:5173
3. ✅ Celery Worker 运行中
4. ✅ 已导入Excel文件，数据库中有设备和测点数据

### 测试 1: 访问设备列表页

**步骤**:
1. 打开浏览器，访问 http://localhost:5173/devices
2. 查看设备列表

**预期结果**:
- ✓ 每个设备卡片右上角显示"查看详情"按钮（蓝色）
- ✓ 设备卡片显示测点数量（例如："测点列表 (25 个)"）
- ✓ 如果测点超过 5 个，显示前 5 个，并提示"... 还有 X 个测点，查看全部"

**截图位置**: 设备列表页

---

### 测试 2: 访问设备详情页

**步骤**:
1. 在设备列表页，点击任意设备的"查看详情"按钮
2. 或直接访问 http://localhost:5173/devices/1（假设设备 ID 为 1）

**预期结果**:
- ✓ 页面标题显示："设备详情: {设备编码}"
- ✓ 右上角有"返回设备列表"按钮
- ✓ 页面分为 4 个卡片区域：
  1. 基本信息
  2. 统计信息
  3. 关联任务
  4. 测点列表

---

### 测试 3: 基本信息卡片

**检查项**:
- ✓ 设备名称
- ✓ 设备编码
- ✓ 协议类型（大写，例如：MODBUSTCP）
- ✓ IP 地址
- ✓ 端口
- ✓ 站点 ID
- ✓ 创建时间（中文格式）
- ✓ 更新时间（中文格式）
- ✓ "测试连接"按钮（蓝色）
- ✓ "删除设备"按钮（红色）

**测试连接功能**:
1. 点击"测试连接"按钮
2. 按钮文字变为"测试中..."
3. 5秒内显示测试结果（绿色框表示成功，红色框表示失败）

**预期结果**:
- ✓ 如果 Celery 和 Redis 正常，测试完成
- ✓ 显示结果消息（例如："✓ 连接测试完成" 或 "✗ 连接失败..."）

**测试删除功能**:
1. 点击"删除设备"按钮
2. 浏览器弹出确认对话框
3. 点击"取消"，不执行删除
4. （可选）再次点击并确认删除

**预期结果**:
- ✓ 确认对话框提示："确定要删除设备 "{设备名称}" 吗？\n\n注意：删除设备将同时删除其所有测点！"
- ✓ 如果确认删除，设备被删除并跳转到设备列表页

---

### 测试 4: 统计信息卡片

**检查项**:
- ✓ 3 个统计卡片，背景色不同（蓝色、紫色、绿色）
- ✓ **测点总数**: 显示数字（例如：25）
- ✓ **关联任务**: 显示数字（例如：2）
- ✓ **最近采集时间**: 显示时间或"从未采集"

**数据验证**:
- 测点总数应该与下方"测点列表"的总数一致
- 关联任务数应该与下方"关联任务"表格的数量一致

---

### 测试 5: 关联任务列表

**检查项**:
- ✓ 如果有关联任务，显示表格：
  - 任务编码
  - 任务名称
  - 状态（启用/停用）
  - 操作列有"查看"链接
- ✓ 点击"查看"链接，跳转到采集控制页面对应任务位置
- ✓ 如果任务超过 5 个，显示提示："显示前 5 个任务，共 X 个"
- ✓ 如果没有关联任务，此卡片不显示

---

### 测试 6: 测点列表

**基本检查**:
- ✓ 表格标题显示："测点列表 (X / Y)"
  - X = 过滤后的测点数
  - Y = 总测点数
- ✓ 右侧有"搜索测点..."输入框
- ✓ 右侧有"导出 CSV"按钮

**表格列**:
- ✓ 编码（加粗显示）
- ✓ 地址
- ✓ 描述
- ✓ 采样率 (Hz)
- ✓ 发送到 Kafka（✓ 是 / ✗ 否）
- ✓ 创建时间

**搜索功能测试**:
1. 在搜索框输入测点编码（例如："temp"）
2. 表格实时过滤，只显示匹配的测点
3. 标题更新为"测点列表 (匹配数 / 总数)"
4. 清空搜索框，显示全部测点

**预期结果**:
- ✓ 搜索匹配测点的编码、描述和地址
- ✓ 不区分大小写

**导出 CSV 功能测试**:
1. 点击"导出 CSV"按钮
2. 浏览器下载文件：`device_{设备编码}_points.csv`
3. 打开 CSV 文件

**预期结果**:
- ✓ CSV 包含所有测点（不受搜索过滤影响）
- ✓ 包含列：编码、地址、描述、采样率(Hz)、发送到Kafka
- ✓ 数据格式正确

---

## 🔧 API 测试（可选）

### 使用 curl 或 Postman 测试

#### 1. 获取设备详情
```bash
curl http://localhost:8000/api/config/devices/1/
```

**预期响应**:
```json
{
  "id": 1,
  "name": "...",
  "code": "...",
  "protocol": "modbustcp",
  "ip_address": "192.168.1.10",
  "port": 502,
  ...
}
```

#### 2. 获取设备测点列表
```bash
curl http://localhost:8000/api/config/devices/1/points/
```

**预期响应**: 测点数组

#### 3. 获取设备统计
```bash
curl http://localhost:8000/api/config/devices/1/stats/
```

**预期响应**:
```json
{
  "total_points": 25,
  "task_count": 2,
  "last_acquisition": "2025-10-10T08:00:00...",
  "related_tasks": [...]
}
```

#### 4. 测试设备连接
```bash
curl -X POST http://localhost:8000/api/config/devices/1/test-connection/
```

**预期响应**:
```json
{
  "success": true,
  "message": "连接测试完成",
  "details": {...}
}
```

---

## 🐛 已知问题和限制

### 1. 连接测试超时
**问题**: 如果 Celery 未运行或 Redis 未连接，连接测试会超时
**现象**: 测试按钮一直显示"测试中..."，最后显示错误
**解决**: 确保 Celery worker 和 Redis 正在运行

### 2. 删除设备的限制
**问题**: 删除设备会级联删除所有测点和任务关联
**现象**: 删除后，关联任务可能没有测点
**建议**: 删除前确认没有正在运行的采集任务

### 3. CSV 导出格式
**限制**: CSV 导出仅包含基本字段
**改进**: 未来可添加更多字段（如模板信息、extra 字段）

---

## 📊 UI 展示

### 设备列表页
```
+----------------------------------------+
| 连接与测点                              |
+----------------------------------------+
| +------------------------------------+ |
| | modbus-192.168.1.10      [查看详情] | |
| | 协议: MODBUSTCP                     | |
| | 地址: 192.168.1.10:502              | |
| | 测点列表 (25 个)                     | |
| |  - temp1        [Kafka]            | |
| |  - pressure1    [本地]              | |
| |  ... (前5个)                        | |
| |  ... 还有 20 个测点，查看全部       | |
| +------------------------------------+ |
```

### 设备详情页
```
+--------------------------------------------------+
| 设备详情: modbus-192.168.1.10   [返回设备列表]   |
+--------------------------------------------------+
| 基本信息                                          |
| 设备名称: ModbusTCP 设备                          |
| 协议类型: MODBUSTCP                               |
| IP: 192.168.1.10  端口: 502                      |
| [测试连接] [删除设备]                             |
| ✓ 连接测试成功                                    |
+--------------------------------------------------+
| 统计信息                                          |
| +--------+  +--------+  +------------------+    |
| | 25     |  | 2      |  | 2025-10-10       |    |
| | 测点   |  | 任务   |  | 08:00:00         |    |
| +--------+  +--------+  +------------------+    |
+--------------------------------------------------+
| 关联任务 (2)                                      |
| task-modbus-192.168.1.10  | 启用 | [查看]      |
+--------------------------------------------------+
| 测点列表 (25 / 25)          [搜索] [导出CSV]     |
| +------+--------+----------+--------+---------+ |
| | 编码  | 地址   | 描述     | 频率   | Kafka   | |
| +------+--------+----------+--------+---------+ |
| | temp | 40001  | 温度     | 1.0    | ✓ 是    | |
| +------+--------+----------+--------+---------+ |
```

---

## ✅ 测试检查清单

完成测试后，确认以下所有项都通过：

- [ ] 设备列表页显示"查看详情"按钮
- [ ] 点击"查看详情"跳转到设备详情页
- [ ] 设备详情页显示完整的基本信息
- [ ] 统计信息卡片显示正确的数据
- [ ] 关联任务列表显示并可以跳转
- [ ] 测点列表显示完整
- [ ] 搜索功能正常工作
- [ ] 导出 CSV 功能正常工作
- [ ] 测试连接功能正常（如果 Celery 运行）
- [ ] 返回按钮正常工作
- [ ] 所有 API 端点返回正确数据

---

## 🎯 下一步

完成测试后，可以继续实施：
1. **版本配置应用功能** (6h)
2. **数据可视化页面** (12h)
3. **修复单元测试** (4h)

或者基于测试反馈改进设备详情页功能。

---

## 📞 需要帮助？

如果遇到问题：
1. 检查浏览器控制台（F12）的错误信息
2. 检查后端日志：`tail -f logs/django.log`
3. 检查 Celery 日志：`tail -f logs/celery.log`
4. 告诉我具体的错误信息，我会立即帮你解决！
